name: CI Validation

on:
  pull_request:
    branches:
      - "develop"
      - "feature/*"
      - "renovate/*"

jobs:
  version-check:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false && (
        contains(github.event.pull_request.head.ref, 'skip-ci') == false
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version consistency
        run: |
          chmod +x bin/validate-versions.sh
          bin/validate-versions.sh

  ui-build-test:
    name: UI Build & Tests
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false && (
        contains(github.event.pull_request.head.ref, 'skip-ci') == false
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        working-directory: ui
        run: npm ci

      - name: Build UI
        id: ui-build
        working-directory: ui
        run: |
          echo "::group::Building UI"
          npm run build-prod
          echo "::endgroup::"

      - name: Validation (format check)
        id: ui-validation
        working-directory: ui
        run: |
          echo "::group::Validating code format"
          npm run format:check
          echo "::endgroup::"

      - name: Lint UI
        id: ui-lint
        working-directory: ui
        run: |
          echo "::group::Linting UI code"
          npm run lint
          echo "::endgroup::"

      - name: Test UI
        id: ui-test
        working-directory: ui
        run: |
          echo "::group::Running UI tests"
          npm run ci-test
          echo "::endgroup::"

  api-build-test:
    name: API Build & Tests
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false && (
        contains(github.event.pull_request.head.ref, 'skip-ci') == false
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Setup SDKMAN
        uses: sdkman/sdkman-action@master
        with:
          candidate: maven
          version: "3.9.6"

      - name: Maven version
        run: mvn -version

      - name: Build API module
        id: api-build
        run: |
          echo "::group::Building API module"
          mvn clean install -pl api -am --batch-mode
          echo "::endgroup::"

      - name: Run API unit tests
        id: api-tests
        run: |
          echo "::group::Running API unit tests"
          mvn test -pl api --batch-mode
          echo "::endgroup::"

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [ ui-build-test, api-build-test ]
    if: |
      github.event.pull_request.draft == false && (
        contains(github.event.pull_request.head.ref, 'skip-ci') == false
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Setup SDKMAN
        uses: sdkman/sdkman-action@master
        with:
          candidate: maven
          version: "3.9.6"

      - name: Maven version
        run: mvn -version

      - name: Build API and test modules
        id: build-all
        run: |
          echo "::group::Building API and test modules"
          mvn clean install -pl api,test -am -DskipTests --batch-mode
          echo "::endgroup::"

      - name: Run API integration tests
        id: integration-tests
        run: |
          echo "::group::Running API integration tests"
          mvn verify -pl test -Prun-api-tests --batch-mode
          echo "::endgroup::"
        env:
          OAUTH_CLIENTID: "${{secrets.OAUTH_CLIENTID}}"
          OAUTH_CLIENTSECRET: "${{secrets.OAUTH_CLIENTSECRET}}"
          OAUTH_AUDIENCE: "${{secrets.OAUTH_AUDIENCE}}"
          OAUTH_ISSUER: "${{secrets.OAUTH_ISSUER}}"
          OKTA_USERNAME: "${{secrets.OKTA_USERNAME}}"
          OKTA_PASSWORD: "${{secrets.OKTA_PASSWORD}}"
          OKTA_URL: "${{secrets.OKTA_URL}}"
          BASE_URL: "http://localhost:8080"
          APP_START_CHECK_RETRY_LIMIT: 100
