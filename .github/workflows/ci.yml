name: CI Validation

on:
  pull_request:
    branches:
      - "develop"
      - "feature/*"
      - "renovate/*"

jobs:
  version-check:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false && (
        contains(github.event.pull_request.head.ref, 'skip-ci') == false
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version consistency
        run: |
          chmod +x scripts/validate-versions.sh
          scripts/validate-versions.sh

  backend:
    name: Backend Build & Tests
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false && (
        contains(github.event.pull_request.head.ref, 'skip-ci') == false
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Setup SDKMAN
        uses: sdkman/sdkman-action@master
        with:
          candidate: maven
          version: "@"
          sdkmanrc: ".sdkmanrc"

      - name: Maven version
        run: mvn -version

      - name: Build and run unit tests
        run: mvn clean install -DskipTests=false

      - name: Run API integration tests
        run: mvn verify -pl test -Prun-api-tests
        env:
          OAUTH_CLIENTID: "${{secrets.OAUTH_CLIENTID}}"
          OAUTH_CLIENTSECRET: "${{secrets.OAUTH_CLIENTSECRET}}"
          OAUTH_AUDIENCE: "${{secrets.OAUTH_AUDIENCE}}"
          OAUTH_ISSUER: "${{secrets.OAUTH_ISSUER}}"
          OKTA_USERNAME: "${{secrets.OKTA_USERNAME}}"
          OKTA_PASSWORD: "${{secrets.OKTA_PASSWORD}}"
          OKTA_URL: "${{secrets.OKTA_URL}}"
          BASE_URL: "http://localhost:8080"
          APP_START_CHECK_RETRY_LIMIT: 100

  frontend:
    name: Frontend Lint & Tests
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false && (
        contains(github.event.pull_request.head.ref, 'skip-ci') == false
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'ui/package-lock.json'

      - name: Install dependencies
        working-directory: ./ui
        run: npm ci

      - name: Run linter
        working-directory: ./ui
        run: npm run lint

      - name: Run tests
        working-directory: ./ui
        run: npm run ci-test

      - name: Build production
        working-directory: ./ui
        run: npm run build-prod

